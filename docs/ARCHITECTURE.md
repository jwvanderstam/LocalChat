# LocalChat Architecture Documentation

**Version:** 0.3.1  
**Last Updated:** January 2025  
**Status:** Production Ready

---

## Table of Contents

1. [System Overview](#system-overview)
2. [Architecture Diagram](#architecture-diagram)
3. [Component Details](#component-details)
4. [Data Flow](#data-flow)
5. [Technology Stack](#technology-stack)
6. [Caching Strategy](#caching-strategy)
7. [Security Architecture](#security-architecture)
8. [Deployment Architecture](#deployment-architecture)
9. [Performance Considerations](#performance-considerations)
10. [Future Enhancements](#future-enhancements)

---

## System Overview

LocalChat is a **production-ready Retrieval-Augmented Generation (RAG)** application that enables users to chat with their documents using local LLMs. The system combines document processing, vector search, intelligent caching, and streaming responses to deliver accurate, context-aware answers.

### Key Characteristics

- **Local-First**: All processing happens locally, no data leaves your infrastructure
- **Production-Ready**: Comprehensive error handling, logging, and monitoring
- **Scalable**: Modular design with caching and optimization layers
- **Real-Time**: Streaming responses via Server-Sent Events (SSE)
- **Flexible**: Multiple cache backends, hybrid search, configurable parameters

---

## Architecture Diagram

### High-Level Architecture

```
???????????????????????????????????????????????????????????????????????
?                          LocalChat System                            ?
?                                                                       ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                      Presentation Layer                       ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ?  Web UI    ?  ?  API Docs  ?  ? Monitoring ?             ?  ?
?  ?  ? (Browser)  ?  ?  /api/docs ?  ? Dashboard  ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                               ?                                      ?
?                               ?                                      ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                      API Layer (Flask)                        ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ?    Web     ?  ?    API     ?  ?  Document  ?             ?  ?
?  ?  ?   Routes   ?  ?   Routes   ?  ?   Routes   ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ??????????????  ??????????????                              ?  ?
?  ?  ?   Model    ?  ?   Error    ?                              ?  ?
?  ?  ?   Routes   ?  ?  Handlers  ?                              ?  ?
?  ?  ??????????????  ??????????????                              ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                               ?                                      ?
?                               ?                                      ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                    Middleware Layer                           ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ? Security   ?  ?Rate Limit  ?  ?   CORS     ?             ?  ?
?  ?  ?Middleware  ?  ?Middleware  ?  ? Middleware ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ??????????????  ??????????????                              ?  ?
?  ?  ?  Logging   ?  ? Validation ?                              ?  ?
?  ?  ?Middleware  ?  ?Middleware  ?                              ?  ?
?  ?  ??????????????  ??????????????                              ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                               ?                                      ?
?                               ?                                      ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                     Service Layer                             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ?    RAG     ?  ? Document   ?  ?   Model    ?             ?  ?
?  ?  ?  Engine    ?  ? Processor  ?  ?  Manager   ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ?   Cache    ?  ?  Security  ?  ?Monitoring  ?             ?  ?
?  ?  ?  Manager   ?  ?  Service   ?  ?  Service   ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                               ?                                      ?
?                               ?                                      ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                     Integration Layer                         ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ? PostgreSQL ?  ?   Ollama   ?  ?   Redis    ?             ?  ?
?  ?  ?   Client   ?  ?   Client   ?  ?   Client   ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                               ?                                      ?
?                               ?                                      ?
?  ????????????????????????????????????????????????????????????????  ?
?  ?                    External Services                          ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ?  ?PostgreSQL  ?  ?   Ollama   ?  ?   Redis    ?             ?  ?
?  ?  ?+ pgvector  ?  ?   Server   ?  ?  Server    ?             ?  ?
?  ?  ??????????????  ??????????????  ??????????????             ?  ?
?  ????????????????????????????????????????????????????????????????  ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
```

### Component Interaction

```
User Request Flow:
  Browser ? Flask Routes ? Middleware ? Services ? Integration Layer ? External Services

Response Flow:
  External Services ? Integration Layer ? Services ? Middleware ? SSE Stream ? Browser
```

---

## Component Details

### 1. Presentation Layer

#### Web UI
- **Technology**: HTML5, CSS3, JavaScript (ES6+)
- **Features**:
  - Chat interface with real-time streaming
  - Document management dashboard
  - Model management interface
  - System overview and health checks
- **Key Files**: `templates/*.html`, `static/js/*.js`, `static/css/*.css`

#### API Documentation
- **Technology**: Swagger/OpenAPI (Flasgger)
- **Endpoint**: `/api/docs/`
- **Features**:
  - Interactive API explorer
  - Request/response schemas
  - Example payloads
  - Authentication documentation

### 2. API Layer (Flask)

#### Route Modules

**Web Routes** (`src/routes/web_routes.py`)
- Serves HTML pages
- Handles template rendering
- Session management

**API Routes** (`src/routes/api_routes.py`)
- `/api/status` - System health check
- `/api/chat` - Chat with streaming
- Core API endpoints

**Document Routes** (`src/routes/document_routes.py`)
- `/api/documents/upload` - Upload with progress
- `/api/documents/list` - List all documents
- `/api/documents/stats` - Document statistics
- `/api/documents/test` - Test RAG retrieval
- `/api/documents/clear` - Clear all documents

**Model Routes** (`src/routes/model_routes.py`)
- `/api/models/` - List available models
- `/api/models/active` - Get/set active model
- `/api/models/pull` - Pull model with progress
- `/api/models/delete` - Delete model
- `/api/models/test` - Test model

### 3. Middleware Layer

#### Security Middleware
- **JWT Authentication**: Optional token-based auth
- **Rate Limiting**: Configurable per endpoint
- **CORS**: Cross-origin request handling
- **Input Sanitization**: XSS, SQL injection prevention

#### Monitoring Middleware
- **Request Timing**: Track slow operations
- **Error Logging**: Structured error capture
- **Metrics Collection**: Performance metrics
- **Health Checks**: Service availability monitoring

### 4. Service Layer

#### RAG Engine (`src/rag.py`)
- **Responsibilities**:
  - Document chunking with table preservation
  - Hybrid search (semantic + BM25)
  - Multi-signal reranking
  - Context formatting for LLM
  - Query expansion
  
- **Key Features**:
  - Intelligent chunking with overlap
  - Table-aware splitting
  - Reciprocal rank fusion
  - Diversity filtering
  - Confidence scoring

#### Document Processor
- **Responsibilities**:
  - File format detection
  - Text extraction (PDF, DOCX, TXT, MD)
  - Table detection and extraction
  - Duplicate prevention
  - Document fingerprinting

- **Key Features**:
  - pdfplumber for advanced PDF processing
  - python-docx for Word documents
  - Table structure preservation
  - SHA-256 content hashing

#### Cache Manager (`src/cache/`)
- **Responsibilities**:
  - Embedding caching
  - Query result caching
  - Cache statistics
  - Automatic eviction

- **Backends**:
  - **Redis**: Distributed, persistent, production-ready
  - **Memory**: Fast, simple, development-friendly

### 5. Integration Layer

#### PostgreSQL Client (`src/db.py`)
- **Features**:
  - Connection pooling (2-10 connections)
  - pgvector integration
  - HNSW index management
  - Transaction management
  - Migration support

#### Ollama Client (`src/ollama_client.py`)
- **Features**:
  - Model management
  - Embedding generation
  - Chat completion streaming
  - Model pulling with progress
  - Health checking

#### Redis Client (Optional)
- **Features**:
  - Key-value storage
  - TTL management
  - Atomic operations
  - Graceful fallback to memory cache

---

## Data Flow

### Document Upload Flow

```
1. User uploads document(s)
   ?
2. Flask receives multipart/form-data
   ?
3. Validation: file type, size, duplicate check
   ?
4. Text extraction:
   - PDF: pdfplumber (with table detection)
   - DOCX: python-docx
   - TXT/MD: direct read
   ?
5. Table detection and marking
   ?
6. Intelligent chunking:
   - Standard chunks: 1024 chars
   - Table chunks: 3000 chars (keep intact)
   - Overlap: 200 chars (20%)
   ?
7. Generate embeddings (batched):
   - Cache check first
   - Ollama API: nomic-embed-text
   - Batch size: 32
   ?
8. Store in PostgreSQL:
   - Documents table: metadata
   - Chunks table: text + vector
   - HNSW index: fast search
   ?
9. Cache embeddings (7 day TTL)
   ?
10. Stream progress to client (SSE)
```

### RAG Query Flow

```
1. User sends chat message
   ?
2. Input validation and sanitization
   ?
3. Check query cache (1 hour TTL)
   ?
4. Generate query embedding:
   - Cache check
   - Ollama API if needed
   - Cache result
   ?
5. Hybrid search:
   a. Semantic search:
      - Vector similarity (cosine)
      - Top-K candidates (40)
      - Threshold: 0.28
   b. BM25 keyword search:
      - Term frequency
      - Inverse document frequency
      - Top-K candidates (40)
   ?
6. Reciprocal Rank Fusion:
   - Combine semantic + BM25 scores
   - Rerank by relevance
   - Select top 12 chunks
   ?
7. Diversity filtering:
   - Remove near-duplicates
   - Jaccard similarity < 0.85
   ?
8. Context formatting:
   - Add source citations
   - Format for LLM
   - Limit to 20,000 chars
   ?
9. LLM generation:
   - System prompt (strict RAG rules)
   - Context + query
   - Stream tokens (SSE)
   - Temperature: 0.0 (factual)
   ?
10. Cache query result
    ?
11. Stream response to client
```

### Caching Flow

```
Embedding Cache:
  Query Embedding Request
    ?
  Check Cache (key: text hash)
    ? Hit
  Return Cached Embedding (instant)
    ? Miss
  Generate via Ollama (slow)
    ?
  Store in Cache (TTL: 7 days)
    ?
  Return New Embedding

Query Cache:
  RAG Query Request
    ?
  Check Cache (key: query hash + params)
    ? Hit
  Return Cached Results (instant)
    ? Miss
  Execute Full RAG Pipeline (slow)
    ?
  Store in Cache (TTL: 1 hour)
    ?
  Return New Results
```

---

## Technology Stack

### Backend

| Component | Technology | Version | Purpose |
|-----------|-----------|---------|---------|
| **Framework** | Flask | 3.0.0 | Web framework |
| **ASGI** | Werkzeug | 3.0.1 | WSGI server |
| **Validation** | Pydantic | 2.12.5 | Data validation |
| **Database Driver** | psycopg[binary] | >=3.2.0 | PostgreSQL connector |
| **HTTP Client** | requests | 2.31.0 | API calls |
| **Caching** | redis (optional) | 5.0.1 | Distributed cache |
| **API Docs** | flasgger | 0.9.7.1 | Swagger/OpenAPI |

### Document Processing

| Component | Technology | Version | Purpose |
|-----------|-----------|---------|---------|
| **PDF** | PyPDF2 | 3.0.1 | PDF text extraction |
| **PDF Tables** | pdfplumber | 0.11.0 | Advanced PDF + tables |
| **Word** | python-docx | 1.1.0 | DOCX processing |
| **Markdown** | markdown | 3.5.1 | MD rendering |

### Security & Middleware

| Component | Technology | Version | Purpose |
|-----------|-----------|---------|---------|
| **Auth** | Flask-JWT-Extended | 4.6.0 | JWT authentication |
| **Rate Limit** | Flask-Limiter | 3.5.0 | API rate limiting |
| **CORS** | Flask-CORS | 4.0.0 | Cross-origin support |
| **Sanitization** | Custom | - | XSS/injection prevention |

### External Services

| Service | Technology | Purpose |
|---------|-----------|---------|
| **Database** | PostgreSQL 15+ | Document & vector storage |
| **Vector Extension** | pgvector 0.5+ | Similarity search |
| **LLM** | Ollama | Local LLM inference |
| **Embeddings** | nomic-embed-text | Vector generation |
| **Cache** | Redis 7+ (optional) | Distributed caching |

### Development

| Tool | Purpose |
|------|---------|
| **pytest** | Testing framework |
| **black** | Code formatting |
| **pylint** | Linting |
| **mypy** | Type checking |
| **coverage** | Code coverage |

---

## Caching Strategy

### Two-Tier Caching

```
???????????????????????????????????????????
?         Application Cache Layer         ?
???????????????????????????????????????????
?                                          ?
?  ???????????????????  ???????????????? ?
?  ? Embedding Cache ?  ? Query Cache  ? ?
?  ?                 ?  ?              ? ?
?  ? TTL: 7 days    ?  ? TTL: 1 hour  ? ?
?  ? Size: 5000     ?  ? Size: 1000   ? ?
?  ? Type: Vector   ?  ? Type: Result ? ?
?  ???????????????????  ???????????????? ?
?           ?                   ?          ?
????????????????????????????????????????????
            ?                   ?
            ?                   ?
   ??????????????????????????????????
   ?     Cache Backend Layer        ?
   ??????????????????????????????????
   ?  ????????????  ?????????????? ?
   ?  ?  Redis   ?  ?   Memory   ? ?
   ?  ?  Cache   ?  ?   Cache    ? ?
   ?  ?          ?  ?            ? ?
   ?  ? Distrib- ?  ? Fast, No   ? ?
   ?  ? uted,    ?  ? external   ? ?
   ?  ? Persist- ?  ? deps       ? ?
   ?  ? ent      ?  ?            ? ?
   ?  ????????????  ?????????????? ?
   ??????????????????????????????????
```

### Cache Configuration

#### Embedding Cache
- **Purpose**: Cache vector embeddings to avoid regeneration
- **Key**: SHA-256 hash of text content
- **TTL**: 7 days (604800 seconds)
- **Capacity**: 5000 embeddings
- **Eviction**: LRU (Least Recently Used)
- **Hit Rate Target**: >80%

#### Query Cache  
- **Purpose**: Cache complete RAG query results
- **Key**: Query text + parameters hash
- **TTL**: 1 hour (3600 seconds)
- **Capacity**: 1000 queries
- **Eviction**: LRU
- **Hit Rate Target**: >60%

### Backend Selection

```python
# Environment variable controls backend
REDIS_ENABLED=False  # Use memory cache (default)
REDIS_ENABLED=True   # Use Redis cache

# Automatic fallback
if redis_available and REDIS_ENABLED:
    use Redis cache
else:
    use Memory cache
    log warning
```

### Performance Impact

| Scenario | Without Cache | With Cache | Improvement |
|----------|--------------|------------|-------------|
| **Embedding Generation** | ~500ms | ~5ms | 100x faster |
| **RAG Query** | ~3-5s | ~200ms | 15-25x faster |
| **Repeated Query** | ~3-5s | ~50ms | 60-100x faster |
| **Memory Usage** | Low | +200MB | Acceptable |

---

## Security Architecture

### Defense in Depth

```
???????????????????????????????????????????
?          Security Layers                ?
???????????????????????????????????????????
?  Layer 1: Network Security              ?
?  - CORS policies                        ?
?  - Rate limiting per IP                 ?
?  - Request size limits                  ?
???????????????????????????????????????????
?  Layer 2: Authentication (Optional)     ?
?  - JWT tokens                           ?
?  - Token expiration                     ?
?  - Refresh tokens                       ?
???????????????????????????????????????????
?  Layer 3: Input Validation              ?
?  - Pydantic models                      ?
?  - Type checking                        ?
?  - Range validation                     ?
???????????????????????????????????????????
?  Layer 4: Sanitization                  ?
?  - XSS prevention                       ?
?  - SQL injection prevention             ?
?  - Path traversal prevention            ?
???????????????????????????????????????????
?  Layer 5: Application Logic             ?
?  - Business rule enforcement            ?
?  - Resource access control              ?
?  - Duplicate prevention                 ?
???????????????????????????????????????????
?  Layer 6: Data Security                 ?
?  - Database connection encryption       ?
?  - Secure credential storage            ?
?  - Audit logging                        ?
???????????????????????????????????????????
```

### Rate Limiting

```python
# Configurable per endpoint
RATELIMIT_CHAT = "10 per minute"      # Chat endpoint
RATELIMIT_UPLOAD = "5 per hour"       # File uploads
RATELIMIT_MODELS = "20 per minute"    # Model operations
RATELIMIT_GENERAL = "60 per minute"   # Other endpoints
```

### Input Validation

```python
# Pydantic models ensure type safety
class ChatRequest(BaseModel):
    message: str = Field(min_length=1, max_length=5000)
    use_rag: bool = True
    history: List[ChatMessage] = []

# Sanitization prevents injection
def sanitize_query(query: str) -> str:
    # Remove dangerous characters
    # Escape HTML/SQL
    # Validate UTF-8
    return cleaned_query
```

---

## Deployment Architecture

### Development

```
Developer Machine
  ?? Python 3.10+
  ?? PostgreSQL (local)
  ?? Ollama (local)
  ?? Redis (optional, local)
  ?? Flask dev server
```

### Production (Single Server)

```
Production Server
  ?? gunicorn (4 workers)
  ?? PostgreSQL 15 + pgvector
  ?? Ollama (GPU-enabled)
  ?? Redis 7 (persistent)
  ?? Nginx (reverse proxy)
  ?? Systemd (process management)
```

### Production (Distributed)

```
???????????????????????????????????????????
?         Load Balancer (Nginx)           ?
???????????????????????????????????????????
               ?
    ???????????????????????
    ?                     ?
    ?                     ?
??????????           ??????????
? App 1  ?           ? App 2  ?
? Flask  ?           ? Flask  ?
??????????           ??????????
     ?                    ?
     ??????????????????????
                ?
        ?????????????????
        ?               ?
        ?               ?
??????????????   ?????????????
? PostgreSQL ?   ?   Redis   ?
? + pgvector ?   ? Cluster   ?
??????????????   ?????????????
        ?
        ?
??????????????
?   Ollama   ?
? (GPU node) ?
??????????????
```

### Docker Deployment

```yaml
# docker-compose.yml
services:
  app:
    build: .
    ports:
      - "5000:5000"
    depends_on:
      - postgres
      - redis
      - ollama
  
  postgres:
    image: pgvector/pgvector:pg15
    volumes:
      - pgdata:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
  
  ollama:
    image: ollama/ollama
    volumes:
      - ollama:/root/.ollama
```

---

## Performance Considerations

### Bottlenecks & Solutions

| Bottleneck | Impact | Solution |
|------------|--------|----------|
| **Embedding Generation** | ~500ms per doc | ? Batch processing + caching |
| **Vector Search** | ~100-200ms | ? HNSW index + caching |
| **LLM Generation** | ~2-4s | ? Streaming + model optimization |
| **Database Queries** | ~50-100ms | ? Connection pooling + indexes |
| **Memory Usage** | High with large docs | ? Streaming uploads + chunking |

### Optimization Techniques

1. **Caching**:
   - Embedding cache: 100x speedup
   - Query cache: 15-25x speedup
   - Redis for distributed environments

2. **Indexing**:
   - HNSW for approximate nearest neighbors
   - B-tree indexes on document metadata
   - Partial indexes for active documents

3. **Batching**:
   - Embedding generation: batch size 32
   - Database inserts: bulk operations
   - Parallel processing: 8 workers

4. **Streaming**:
   - File uploads: chunked transfer
   - LLM responses: token-by-token
   - Progress updates: Server-Sent Events

5. **Connection Management**:
   - Database: pooling (2-10 connections)
   - HTTP: keep-alive
   - Resource cleanup: context managers

---

## Future Enhancements

### Planned Features

#### Month 4 (Q1 2025)
- [ ] Advanced query expansion with synonyms
- [ ] Multi-language embedding support
- [ ] Improved table extraction with structure preservation
- [ ] Query performance dashboard
- [ ] Advanced caching strategies (tiered caching)

#### Month 5 (Q2 2025)
- [ ] Kubernetes deployment configs
- [ ] Horizontal scaling support
- [ ] Advanced monitoring (Prometheus/Grafana)
- [ ] A/B testing framework
- [ ] Enhanced API rate limiting with Redis

#### Month 6 (Q3 2025)
- [ ] Multi-model support (ensemble RAG)
- [ ] Fine-tuning pipeline
- [ ] Plugin system for custom processors
- [ ] Admin dashboard with analytics
- [ ] Workflow automation

### Research Areas

- **Semantic Chunking**: Sentence transformers for intelligent boundaries
- **Multi-Vector Search**: Different embeddings for different use cases
- **Query Routing**: Automatic selection of search strategy
- **Response Confidence**: Uncertainty quantification
- **Context Compression**: Reduce token usage while maintaining quality

---

## References

### Documentation
- [Installation Guide](INSTALLATION.md)
- [Development Guide](DEVELOPMENT.md)
- [API Documentation](API.md)
- [Troubleshooting](TROUBLESHOOTING.md)

### Technologies
- [Flask Documentation](https://flask.palletsprojects.com/)
- [pgvector Documentation](https://github.com/pgvector/pgvector)
- [Ollama Documentation](https://ollama.ai/docs)
- [Redis Documentation](https://redis.io/docs/)
- [Pydantic Documentation](https://docs.pydantic.dev/)

---

**Last Updated:** January 2025  
**Version:** 0.3.1  
**Status:** Production Ready  
**Maintainer:** LocalChat Team

