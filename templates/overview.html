{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">System Overview</h1>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#architectureModal">
        <i class="bi bi-diagram-3 me-2"></i>View Architecture Details
    </button>
</div>

<div class="row">
    <!-- System Status -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle me-2"></i>System Status
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-cpu me-2"></i>Ollama Service</span>
                        <span class="badge bg-secondary" id="overview-ollama-status">Checking...</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-database me-2"></i>PostgreSQL + pgvector</span>
                        <span class="badge bg-secondary" id="overview-db-status">Checking...</span>
                    </div>
                </div>
                <hr>
                <div class="mb-2">
                    <strong>Active Model:</strong><br>
                    <code id="overview-model">Loading...</code>
                </div>
                <div>
                    <strong>Documents Indexed:</strong><br>
                    <span class="fs-4" id="overview-doc-count">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-speedometer2 me-2"></i>Performance Metrics
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted small">Total Chunks</label>
                    <h3 id="metric-chunks">0</h3>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Database Connection Pool</label>
                    <p class="mb-0">
                        <span class="badge bg-info">Min: 2</span>
                        <span class="badge bg-info">Max: 10</span>
                    </p>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Parallel Workers</label>
                    <p class="mb-0">
                        <span class="badge bg-info">4 threads</span>
                    </p>
                </div>
                <div>
                    <label class="text-muted small">Chunk Size</label>
                    <p class="mb-0">
                        <span class="badge bg-info">500 tokens</span>
                        <span class="badge bg-info">50 overlap</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-gear me-2"></i>Configuration
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Ollama URL:</strong><br>
                    <code>http://localhost:11434</code>
                </div>
                <div class="mb-2">
                    <strong>Database:</strong><br>
                    <code>localhost:5432/rag_db</code>
                </div>
                <div class="mb-2">
                    <strong>Top-K Results:</strong><br>
                    <code>5 chunks</code>
                </div>
                <div>
                    <strong>Supported Formats:</strong><br>
                    <span class="badge bg-secondary">PDF</span>
                    <span class="badge bg-secondary">TXT</span>
                    <span class="badge bg-secondary">DOCX</span>
                    <span class="badge bg-secondary">MD</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comprehensive Features Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-list-check me-2"></i>Comprehensive Features & Functions
            </div>
            <div class="card-body">
                <div class="accordion" id="featuresAccordion">
                    <!-- Core RAG Features -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#coreRAG">
                                <i class="bi bi-diagram-3 me-2"></i><strong>Core RAG (Retrieval-Augmented Generation)</strong>
                            </button>
                        </h2>
                        <div id="coreRAG" class="accordion-collapse collapse show" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Document Ingestion:</strong> Upload PDF, TXT, DOCX, MD files</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Smart Chunking:</strong> 500-token chunks with 50-token overlap</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Vector Embeddings:</strong> Generate embeddings via Ollama</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Semantic Search:</strong> pgvector cosine similarity search</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Context Retrieval:</strong> Top-K most relevant chunks</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Query Augmentation:</strong> Inject context into LLM prompts</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Features -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chatFeatures">
                                <i class="bi bi-chat-left-text me-2"></i><strong>Chat & Conversation</strong>
                            </button>
                        </h2>
                        <div id="chatFeatures" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>RAG Mode:</strong> Document-grounded responses</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Direct LLM Mode:</strong> Standard chat without documents</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Streaming Responses:</strong> Real-time text generation (SSE)</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Conversation History:</strong> Context-aware multi-turn chat</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Source Attribution:</strong> See which documents answered</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Copy/Clear:</strong> Easy message management</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Document Management -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#docManagement">
                                <i class="bi bi-folder me-2"></i><strong>Document Management</strong>
                            </button>
                        </h2>
                        <div id="docManagement" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Multi-file Upload:</strong> Batch document processing</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Progress Tracking:</strong> Real-time ingestion status</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Document List:</strong> View all indexed documents</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Duplicate Detection:</strong> Prevent re-indexing</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Test Retrieval:</strong> Query testing interface</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Clear Database:</strong> Remove all documents</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Statistics:</strong> Document & chunk counts</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Model Management -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modelManagement">
                                <i class="bi bi-cpu me-2"></i><strong>Model Management</strong>
                            </button>
                        </h2>
                        <div id="modelManagement" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>List Models:</strong> View all installed Ollama models</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Active Model:</strong> Switch between models dynamically</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Pull Models:</strong> Download new models with progress</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Delete Models:</strong> Remove unused models</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Test Models:</strong> Verify model functionality</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Model Info:</strong> Size, modified date, parameters</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Error Handling & Validation -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#errorHandling">
                                <i class="bi bi-shield-check me-2"></i><strong>Error Handling & Validation</strong>
                            </button>
                        </h2>
                        <div id="errorHandling" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>11 Custom Exceptions:</strong> Specific error types</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Pydantic Validation:</strong> 8 validation models</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Input Sanitization:</strong> XSS, injection prevention</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>HTTP Error Handlers:</strong> 400, 404, 405, 413, 500</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>User-Friendly Messages:</strong> Clear error descriptions</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Error Logging:</strong> Comprehensive log tracking</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Database & Storage -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#database">
                                <i class="bi bi-database me-2"></i><strong>Database & Storage</strong>
                            </button>
                        </h2>
                        <div id="database" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>PostgreSQL:</strong> Robust relational database</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>pgvector Extension:</strong> Vector similarity search</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Connection Pooling:</strong> 2-10 connections</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Transaction Safety:</strong> ACID guarantees</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Schema Versioning:</strong> Automatic setup</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Batch Operations:</strong> Efficient chunk insertion</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Features -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#performance">
                                <i class="bi bi-speedometer2 me-2"></i><strong>Performance & Optimization</strong>
                            </button>
                        </h2>
                        <div id="performance" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Parallel Processing:</strong> 4 worker threads</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Batch Embeddings:</strong> Process 10 chunks at once</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Connection Reuse:</strong> HTTP session pooling</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Streaming Responses:</strong> SSE for real-time output</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Efficient Chunking:</strong> Sentence boundary respect</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Vector Indexing:</strong> Fast similarity search</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Testing & Quality -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#testing">
                                <i class="bi bi-check2-square me-2"></i><strong>Testing & Quality Assurance</strong>
                            </button>
                        </h2>
                        <div id="testing" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>231 Unit Tests:</strong> Comprehensive test coverage</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>59% Code Coverage:</strong> Core modules well-tested</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>100% Exception Coverage:</strong> All errors tested</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>95% Validation Coverage:</strong> Input validation verified</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Fast Execution:</strong> 1.39s for all tests</li>
                                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Edge Case Testing:</strong> Boundary conditions covered</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Structure Section - NEW -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-purple text-white" style="background-color: #6f42c1 !important;">
                <i class="bi bi-folder-fill me-2"></i>Application File Structure
                <button class="btn btn-sm btn-light float-end" data-bs-toggle="modal" data-bs-target="#fileStructureModal">
                    <i class="bi bi-file-text me-1"></i>View Full Documentation
                </button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h2 class="text-primary">100+</h2>
                                <p class="mb-0 small text-muted">Total Files</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h2 class="text-success">~19K</h2>
                                <p class="mb-0 small text-muted">Lines of Code</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h2 class="text-info">12</h2>
                                <p class="mb-0 small text-muted">Core Modules</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h2 class="text-warning">50+</h2>
                                <p class="mb-0 small text-muted">Documentation</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion" id="fileStructureAccordion">
                    <!-- Core Application Files -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#coreFiles">
                                <i class="bi bi-code-square me-2 text-primary"></i><strong>src/ - Core Application Files</strong>
                                <span class="badge bg-primary ms-2">12 modules</span>
                            </button>
                        </h2>
                        <div id="coreFiles" class="accordion-collapse collapse show" data-bs-parent="#fileStructureAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/app.py</code></h6>
                                            <small class="text-muted">~800 lines</small>
                                        </div>
                                        <p class="mb-1">Flask web application with routes and API endpoints</p>
                                        <small class="text-muted">
                                            Web routes, REST API, SSE streaming, error handling, input validation
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/config.py</code></h6>
                                            <small class="text-muted">~200 lines</small>
                                        </div>
                                        <p class="mb-1">Configuration management and application state</p>
                                        <small class="text-muted">
                                            Environment variables, RAG settings, LLM config, security settings
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/db.py</code></h6>
                                            <small class="text-muted">~600 lines</small>
                                        </div>
                                        <p class="mb-1">PostgreSQL database operations with pgvector support</p>
                                        <small class="text-muted">
                                            Connection pooling, CRUD operations, vector similarity search, HNSW indexing
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/rag.py</code></h6>
                                            <small class="text-muted">~800 lines</small>
                                        </div>
                                        <p class="mb-1">Document processing and RAG engine</p>
                                        <small class="text-muted">
                                            Multi-format loading, hierarchical chunking, embedding generation, hybrid search
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/ollama_client.py</code></h6>
                                            <small class="text-muted">~400 lines</small>
                                        </div>
                                        <p class="mb-1">Ollama API client for LLM operations</p>
                                        <small class="text-muted">
                                            Chat completions, embedding generation, model management, streaming
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/exceptions.py</code></h6>
                                            <small class="text-muted">~150 lines</small>
                                        </div>
                                        <p class="mb-1">Custom exception classes (11 types)</p>
                                        <small class="text-muted">
                                            Structured error information, HTTP status mapping, error hierarchy
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/models.py</code></h6>
                                            <small class="text-muted">~400 lines</small>
                                        </div>
                                        <p class="mb-1">Pydantic validation models (8 models)</p>
                                        <small class="text-muted">
                                            Request validation, response formatting, data integrity
                                        </small>
                                    </div>
                                    
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1"><code>src/security.py</code></h6>
                                            <small class="text-muted">~300 lines</small>
                                        </div>
                                        <p class="mb-1">Security middleware (JWT, rate limiting, CORS)</p>
                                        <small class="text-muted">
                                            Authentication, rate limits, security headers, health checks
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Templates -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#templateFiles">
                                <i class="bi bi-file-earmark-code me-2 text-success"></i><strong>templates/ - HTML Templates</strong>
                                <span class="badge bg-success ms-2">5 pages</span>
                            </button>
                        </h2>
                        <div id="templateFiles" class="accordion-collapse collapse" data-bs-parent="#fileStructureAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>templates/base.html</code></h6>
                                        <p class="mb-1">Master template with common layout</p>
                                        <small class="text-muted">Bootstrap 5, navigation, common includes</small>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>templates/chat.html</code></h6>
                                        <p class="mb-1">Interactive chat interface with RAG toggle</p>
                                        <small class="text-muted">Message I/O, history, streaming display</small>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>templates/documents.html</code></h6>
                                        <p class="mb-1">Document management and upload</p>
                                        <small class="text-muted">Multi-file upload, list view, test retrieval</small>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>templates/models.html</code></h6>
                                        <p class="mb-1">Ollama model management</p>
                                        <small class="text-muted">List, pull, delete, set active model</small>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>templates/overview.html</code></h6>
                                        <p class="mb-1">System overview and architecture (this page)</p>
                                        <small class="text-muted">Status, metrics, features, architecture</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tests -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#testFiles">
                                <i class="bi bi-check2-square me-2 text-info"></i><strong>tests/ - Test Suite</strong>
                                <span class="badge bg-info ms-2">231 tests</span>
                            </button>
                        </h2>
                        <div id="testFiles" class="accordion-collapse collapse" data-bs-parent="#fileStructureAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>tests/conftest.py</code></h6>
                                        <p class="mb-1">Shared pytest fixtures</p>
                                        <small class="text-muted">Mock objects, sample data, test helpers</small>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>tests/test_exceptions_comprehensive.py</code></h6>
                                        <p class="mb-1">Exception testing (18 tests, 100% coverage)</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>tests/test_validation_comprehensive.py</code></h6>
                                        <p class="mb-1">Validation testing (27 tests, 95% coverage)</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>tests/unit/*.py</code></h6>
                                        <p class="mb-1">Unit tests for core modules</p>
                                        <small class="text-muted">Config, sanitization, RAG, database, Ollama</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentation -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#docFiles">
                                <i class="bi bi-book me-2 text-warning"></i><strong>docs/ - Documentation</strong>
                                <span class="badge bg-warning ms-2">50+ files</span>
                            </button>
                        </h2>
                        <div id="docFiles" class="accordion-collapse collapse" data-bs-parent="#fileStructureAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/INSTALLATION.md</code></h6>
                                        <p class="mb-1">Complete installation guide</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/API.md</code></h6>
                                        <p class="mb-1">API endpoint documentation</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/ARCHITECTURE.md</code></h6>
                                        <p class="mb-1">System design and components</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/features/*.md</code></h6>
                                        <p class="mb-1">Feature documentation (RAG, tables, optimization)</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/testing/*.md</code></h6>
                                        <p class="mb-1">Testing guides and reports</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/fixes/*.md</code></h6>
                                        <p class="mb-1">Error resolution and fix documentation</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>docs/FILE_STRUCTURE_OVERVIEW.md</code></h6>
                                        <p class="mb-1">Complete file structure documentation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scripts -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#scriptFiles">
                                <i class="bi bi-terminal me-2 text-danger"></i><strong>scripts/ - Utility Scripts</strong>
                                <span class="badge bg-danger ms-2">10+ scripts</span>
                            </button>
                        </h2>
                        <div id="scriptFiles" class="accordion-collapse collapse" data-bs-parent="#fileStructureAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>scripts/setup_db.py</code></h6>
                                        <p class="mb-1">Database initialization</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>scripts/test_*.py</code></h6>
                                        <p class="mb-1">Testing scripts (Ollama, pgvector, RAG, validation)</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>scripts/suppress_warnings.py</code></h6>
                                        <p class="mb-1">Apply warning suppressions</p>
                                    </div>
                                    <div class="list-group-item">
                                        <h6 class="mb-1"><code>scripts/verify_no_errors.py</code></h6>
                                        <p class="mb-1">Error verification and health checks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Architecture Diagram -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-diagram-3 me-2"></i>System Architecture
            </div>
            <div class="card-body">
                <div class="text-center p-4">
                    <svg viewBox="0 0 800 500" style="max-width: 100%; height: auto;">
                        <!-- User -->
                        <g>
                            <rect x="10" y="200" width="120" height="80" fill="#007bff" rx="5"/>
                            <text x="70" y="235" text-anchor="middle" fill="white" font-size="14">User</text>
                            <text x="70" y="255" text-anchor="middle" fill="white" font-size="12">Web Browser</text>
                        </g>
                        
                        <!-- Arrow -->
                        <line x1="130" y1="240" x2="190" y2="240" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <!-- Flask App -->
                        <g>
                            <rect x="190" y="180" width="140" height="120" fill="#28a745" rx="5"/>
                            <text x="260" y="210" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Flask App</text>
                            <text x="260" y="230" text-anchor="middle" fill="white" font-size="11">Routes &amp; API</text>
                            <text x="260" y="245" text-anchor="middle" fill="white" font-size="11">RAG Logic</text>
                            <text x="260" y="260" text-anchor="middle" fill="white" font-size="11">Streaming</text>
                            <text x="260" y="275" text-anchor="middle" fill="white" font-size="11">Connection Pool</text>
                        </g>
                        
                        <!-- Arrow to Ollama -->
                        <line x1="330" y1="200" x2="430" y2="120" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <!-- Ollama -->
                        <g>
                            <rect x="430" y="50" width="140" height="100" fill="#dc3545" rx="5"/>
                            <text x="500" y="80" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Ollama</text>
                            <text x="500" y="100" text-anchor="middle" fill="white" font-size="11">LLM Chat</text>
                            <text x="500" y="115" text-anchor="middle" fill="white" font-size="11">Embeddings</text>
                            <text x="500" y="130" text-anchor="middle" fill="white" font-size="11">Model Mgmt</text>
                        </g>
                        
                        <!-- Arrow to Database -->
                        <line x1="330" y1="280" x2="430" y2="360" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <!-- PostgreSQL + pgvector -->
                        <g>
                            <rect x="430" y="320" width="140" height="120" fill="#6c757d" rx="5"/>
                            <text x="500" y="350" text-anchor="middle" fill="white" font-size="14" font-weight="bold">PostgreSQL</text>
                            <text x="500" y="370" text-anchor="middle" fill="white" font-size="11">+ pgvector</text>
                            <text x="500" y="390" text-anchor="middle" fill="white" font-size="11">Documents</text>
                            <text x="500" y="405" text-anchor="middle" fill="white" font-size="11">Chunks</text>
                            <text x="500" y="420" text-anchor="middle" fill="white" font-size="11">Embeddings</text>
                        </g>
                        
                        <!-- Data Flow Labels -->
                        <text x="160" y="225" text-anchor="middle" fill="#666" font-size="10">HTTP</text>
                        <text x="370" y="150" text-anchor="middle" fill="#666" font-size="10">API</text>
                        <text x="370" y="320" text-anchor="middle" fill="#666" font-size="10">SQL</text>
                        
                        <!-- RAG Flow -->
                        <g>
                            <rect x="620" y="180" width="170" height="140" fill="#17a2b8" fill-opacity="0.1" stroke="#17a2b8" stroke-width="2" rx="5"/>
                            <text x="705" y="205" text-anchor="middle" fill="#17a2b8" font-size="13" font-weight="bold">RAG Pipeline</text>
                            <text x="705" y="230" text-anchor="middle" fill="#333" font-size="10">1. Ingest Documents</text>
                            <text x="705" y="245" text-anchor="middle" fill="#333" font-size="10">2. Chunk Text (500 tokens)</text>
                            <text x="705" y="260" text-anchor="middle" fill="#333" font-size="10">3. Generate Embeddings</text>
                            <text x="705" y="275" text-anchor="middle" fill="#333" font-size="10">4. Store in pgvector</text>
                            <text x="705" y="295" text-anchor="middle" fill="#333" font-size="10">5. Query Embedding</text>
                            <text x="705" y="310" text-anchor="middle" fill="#333" font-size="10">6. Similarity Search</text>
                        </g>
                        
                        <!-- Arrow marker definition -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-link-45deg me-2"></i>Quick Actions
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <a href="/chat" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-chat-left-text d-block fs-3 mb-2"></i>
                            Start Chatting
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/documents" class="btn btn-outline-success w-100 mb-2">
                            <i class="bi bi-upload d-block fs-3 mb-2"></i>
                            Upload Documents
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/models" class="btn btn-outline-info w-100 mb-2">
                            <i class="bi bi-cpu d-block fs-3 mb-2"></i>
                            Manage Models
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button onclick="refreshStatus()" class="btn btn-outline-secondary w-100 mb-2">
                            <i class="bi bi-arrow-clockwise d-block fs-3 mb-2"></i>
                            Refresh Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Architecture Details Modal -->
<div class="modal fade" id="architectureModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-diagram-3 me-2"></i>Detailed Architecture & Functions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-primary">System Architecture Overview</h6>
                <p>LocalChat is a production-ready RAG (Retrieval-Augmented Generation) system with the following architecture:</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mt-3">Core Components:</h6>
                        <ul>
                            <li><strong>Flask Application:</strong> Web server & API (src/app.py)</li>
                            <li><strong>RAG Engine:</strong> Document processing (src/rag.py)</li>
                            <li><strong>Database Layer:</strong> PostgreSQL + pgvector (src/db.py)</li>
                            <li><strong>Ollama Client:</strong> LLM integration (src/ollama_client.py)</li>
                            <li><strong>Error Handling:</strong> 11 custom exceptions (src/exceptions.py)</li>
                            <li><strong>Validation:</strong> 8 Pydantic models (src/models.py)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mt-3">Key Capabilities:</h6>
                        <ul>
                            <li>? 231 comprehensive tests (59% coverage)</li>
                            <li>? Streaming responses (Server-Sent Events)</li>
                            <li>? Connection pooling (2-10 connections)</li>
                            <li>? Parallel processing (4 workers)</li>
                            <li>? Input sanitization & validation</li>
                            <li>? Comprehensive error handling</li>
                            <li>? Professional logging system</li>
                        </ul>
                    </div>
                </div>

                <h6 class="text-primary mt-4">Data Flow:</h6>
                <ol>
                    <li><strong>Document Upload:</strong> User uploads file ? Flask receives ? RAG processes</li>
                    <li><strong>Chunking:</strong> Text split into 500-token chunks with 50-token overlap</li>
                    <li><strong>Embedding:</strong> Each chunk ? Ollama ? 768-dim vector</li>
                    <li><strong>Storage:</strong> Chunks + embeddings ? PostgreSQL with pgvector</li>
                    <li><strong>Query:</strong> User question ? Ollama ? query embedding</li>
                    <li><strong>Retrieval:</strong> Cosine similarity search ? Top-K chunks</li>
                    <li><strong>Generation:</strong> Context + question ? LLM ? Streaming response</li>
                </ol>

                <h6 class="text-primary mt-4">Performance Metrics:</h6>
                <ul>
                    <li>Document Processing: ~5 seconds per MB</li>
                    <li>Query Response: <1 second (retrieval) + LLM time</li>
                    <li>Concurrent Users: Supports multiple simultaneous requests</li>
                    <li>Test Execution: 1.39 seconds for 231 tests</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- File Structure Documentation Modal - NEW -->
<div class="modal fade" id="fileStructureModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #6f42c1; color: white;">
                <h5 class="modal-title"><i class="bi bi-folder-fill me-2"></i>Complete File Structure Documentation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Complete Documentation:</strong> This modal shows a summary. 
                    The full documentation is available in <code>docs/FILE_STRUCTURE_OVERVIEW.md</code> 
                    in your project directory or on 
                    <a href="https://github.com/jwvanderstam/LocalChat/blob/main/docs/FILE_STRUCTURE_OVERVIEW.md" 
                       target="_blank" class="alert-link">GitHub</a>.
                </div>
                
                <h5 class="text-primary mb-3">?? Project Statistics</h5>
                <table class="table table-bordered mb-4">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Count</th>
                            <th>Lines</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Source Code</strong></td>
                            <td>12 files</td>
                            <td>~4,000</td>
                            <td>Core application modules</td>
                        </tr>
                        <tr>
                            <td><strong>Templates</strong></td>
                            <td>5 files</td>
                            <td>~1,500</td>
                            <td>Web interface HTML</td>
                        </tr>
                        <tr>
                            <td><strong>Tests</strong></td>
                            <td>15+ files</td>
                            <td>~2,500</td>
                            <td>Pytest test suite</td>
                        </tr>
                        <tr>
                            <td><strong>Scripts</strong></td>
                            <td>10+ files</td>
                            <td>~1,000</td>
                            <td>Setup and maintenance</td>
                        </tr>
                        <tr>
                            <td><strong>Documentation</strong></td>
                            <td>50+ files</td>
                            <td>~10,000</td>
                            <td>Comprehensive docs</td>
                        </tr>
                        <tr class="table-primary">
                            <td><strong>Total</strong></td>
                            <td><strong>100+</strong></td>
                            <td><strong>~19,000</strong></td>
                            <td><strong>Complete application</strong></td>
                        </tr>
                    </tbody>
                </table>

                <h5 class="text-primary mb-3">?? Key Directories</h5>
                
                <div class="accordion" id="modalFileAccordion">
                    <!-- src/ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#modalSrc">
                                <strong>src/ - Core Application (12 modules, ~4,000 lines)</strong>
                            </button>
                        </h2>
                        <div id="modalSrc" class="accordion-collapse collapse show" data-bs-parent="#modalFileAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><code>app.py</code> (~800) - Flask web app with routes & API</li>
                                    <li><code>config.py</code> (~200) - Configuration & state management</li>
                                    <li><code>db.py</code> (~600) - PostgreSQL + pgvector operations</li>
                                    <li><code>rag.py</code> (~800) - Document processing & RAG engine</li>
                                    <li><code>ollama_client.py</code> (~400) - LLM API client</li>
                                    <li><code>exceptions.py</code> (~150) - 11 custom exception classes</li>
                                    <li><code>models.py</code> (~400) - 8 Pydantic validation models</li>
                                    <li><code>security.py</code> (~300) - JWT, rate limiting, CORS</li>
                                    <li><code>utils/logging_config.py</code> (~150) - Logging system</li>
                                    <li><code>utils/sanitization.py</code> (~200) - Input sanitization</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- templates/ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalTemplates">
                                <strong>templates/ - HTML Templates (5 pages)</strong>
                            </button>
                        </h2>
                        <div id="modalTemplates" class="accordion-collapse collapse" data-bs-parent="#modalFileAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><code>base.html</code> - Master template with layout</li>
                                    <li><code>chat.html</code> - Interactive chat interface</li>
                                    <li><code>documents.html</code> - Document management</li>
                                    <li><code>models.html</code> - Model management</li>
                                    <li><code>overview.html</code> - System overview (this page)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- tests/ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalTests">
                                <strong>tests/ - Test Suite (231 tests, 59% coverage)</strong>
                            </button>
                        </h2>
                        <div id="modalTests" class="accordion-collapse collapse" data-bs-parent="#modalFileAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><code>conftest.py</code> - Shared pytest fixtures</li>
                                    <li><code>test_exceptions_comprehensive.py</code> - 18 tests (100% coverage)</li>
                                    <li><code>test_validation_comprehensive.py</code> - 27 tests (95% coverage)</li>
                                    <li><code>unit/*.py</code> - Unit tests for core modules</li>
                                    <li><code>integration/*.py</code> - Integration tests</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- docs/ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalDocs">
                                <strong>docs/ - Documentation (50+ files)</strong>
                            </button>
                        </h2>
                        <div id="modalDocs" class="accordion-collapse collapse" data-bs-parent="#modalFileAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled">
                                    <li><code>INSTALLATION.md</code> - Complete installation guide</li>
                                    <li><code>API.md</code> - API endpoint documentation</li>
                                    <li><code>ARCHITECTURE.md</code> - System design</li>
                                    <li><code>FILE_STRUCTURE_OVERVIEW.md</code> - This documentation</li>
                                    <li><code>features/</code> - Feature documentation</li>
                                    <li><code>testing/</code> - Testing guides</li>
                                    <li><code>fixes/</code> - Error resolution docs</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <h5 class="text-primary mt-4 mb-3">?? Quick Task Reference</h5>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>File to Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Add new API endpoint</td>
                            <td><code>src/app.py</code></td>
                        </tr>
                        <tr>
                            <td>Change RAG settings</td>
                            <td><code>src/config.py</code></td>
                        </tr>
                        <tr>
                            <td>Modify chunking logic</td>
                            <td><code>src/rag.py</code></td>
                        </tr>
                        <tr>
                            <td>Update database schema</td>
                            <td><code>src/db.py</code></td>
                        </tr>
                        <tr>
                            <td>Add validation rule</td>
                            <td><code>src/models.py</code></td>
                        </tr>
                        <tr>
                            <td>Handle new error type</td>
                            <td><code>src/exceptions.py</code></td>
                        </tr>
                        <tr>
                            <td>Change UI layout</td>
                            <td><code>templates/base.html</code></td>
                        </tr>
                        <tr>
                            <td>Add JavaScript feature</td>
                            <td><code>static/js/*.js</code></td>
                        </tr>
                        <tr>
                            <td>Write new test</td>
                            <td><code>tests/unit/*.py</code></td>
                        </tr>
                        <tr>
                            <td>Update documentation</td>
                            <td><code>docs/*.md</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <a href="https://github.com/jwvanderstam/LocalChat/blob/main/docs/FILE_STRUCTURE_OVERVIEW.md" 
                   target="_blank" class="btn btn-primary">
                    <i class="bi bi-github me-2"></i>View on GitHub
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadOverviewData() {
        try {
            // System status
            const statusResponse = await fetch('/api/status');
            const statusData = await statusResponse.json();
            
            // Ollama status
            const ollamaStatus = document.getElementById('overview-ollama-status');
            if (statusData.ollama) {
                ollamaStatus.className = 'badge bg-success';
                ollamaStatus.textContent = 'Running';
            } else {
                ollamaStatus.className = 'badge bg-danger';
                ollamaStatus.textContent = 'Offline';
            }
            
            // Database status
            const dbStatus = document.getElementById('overview-db-status');
            if (statusData.database) {
                dbStatus.className = 'badge bg-success';
                dbStatus.textContent = 'Connected';
            } else {
                dbStatus.className = 'badge bg-danger';
                dbStatus.textContent = 'Disconnected';
            }
            
            // Active model
            document.getElementById('overview-model').textContent = statusData.active_model || 'None';
            
            // Document count
            document.getElementById('overview-doc-count').textContent = statusData.document_count || 0;
            
            // Document stats
            const statsResponse = await fetch('/api/documents/stats');
            const statsData = await statsResponse.json();
            
            if (statsData.success) {
                document.getElementById('metric-chunks').textContent = statsData.chunk_count || 0;
            }
        } catch (error) {
            console.error('Error loading overview data:', error);
        }
    }
    
    function refreshStatus() {
        loadOverviewData();
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'toast show position-fixed top-0 end-0 m-3';
        toast.innerHTML = `
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">Status refreshed successfully!</div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Load on page load
    loadOverviewData();
    
    // Refresh every 10 seconds
    setInterval(loadOverviewData, 10000);
</script>
{% endblock %}
